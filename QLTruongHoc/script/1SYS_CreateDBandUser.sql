-- Enable OLS
ALTER USER lbacsys IDENTIFIED BY lbacsys ACCOUNT UNLOCK CONTAINER = ALL;
EXEC LBACSYS.CONFIGURE_OLS; 
EXEC LBACSYS.OLS_ENFORCEMENT.ENABLE_OLS;
--  Enable Audit
ALTER SESSION SET CONTAINER = CDB$ROOT;
ALTER SYSTEM SET audit_trail=db SCOPE=SPFILE;
SHUTDOWN IMMEDIATE;
STARTUP;
--------------------------------------------------------------------------------
ALTER SESSION SET CONTAINER = XEPDB1;
ALTER SESSION SET "_ORACLE_SCRIPT"=FALSE;
--------------------------------------------------------------------------------
-- 1. XÓA USER QLTH NẾU USER ĐÃ TỒN TẠI
--------------------------------------------------------------------------------
CREATE OR REPLACE PROCEDURE DROP_OBJ
    (OBJ_DROP VARCHAR2, OBJ_NAME VARCHAR2)
AS
    COUNT_VAR NUMBER;
    STRSQL VARCHAR2(2000);
BEGIN
    STRSQL := 'ALTER SESSION SET "_ORACLE_SCRIPT" = TRUE';
    EXECUTE IMMEDIATE (STRSQL);
    IF (OBJ_DROP = 'USER') THEN
        STRSQL := 'SELECT COUNT(*) FROM DBA_USERS WHERE DBA_USERS.USERNAME = ' || '''' || OBJ_NAME || '''';
        EXECUTE IMMEDIATE (STRSQL) INTO COUNT_VAR;
    ELSIF (OBJ_DROP = 'TABLE') THEN
        STRSQL := 'SELECT COUNT(*) FROM DBA_TABLES WHERE DBA_TABLES.TABLE_NAME = ' || '''' || OBJ_NAME || '''';
        EXECUTE IMMEDIATE (STRSQL) INTO COUNT_VAR;
    ELSIF (OBJ_DROP = 'ROLE') THEN
        STRSQL := 'SELECT COUNT(*) FROM DBA_ROLES WHERE DBA_ROLES.ROLE = ' || '''' || OBJ_NAME || '''';
        EXECUTE IMMEDIATE (STRSQL) INTO COUNT_VAR;
    END IF;
    
    IF (COUNT_VAR = 1 AND OBJ_DROP = 'USER') THEN
        STRSQL := 'DROP ' || OBJ_DROP || ' "' || OBJ_NAME || '" CASCADE';
        DBMS_OUTPUT.PUT_LINE(STRSQL);
        EXECUTE IMMEDIATE (STRSQL);
    END IF;
    IF (COUNT_VAR = 1) THEN
        STRSQL := 'DROP ' || OBJ_DROP || ' "' || OBJ_NAME || '"';
        DBMS_OUTPUT.PUT_LINE(STRSQL);
        EXECUTE IMMEDIATE (STRSQL);
    END IF;
    STRSQL := 'ALTER SESSION SET "_ORACLE_SCRIPT" = FALSE';
    EXECUTE IMMEDIATE (STRSQL);
END;
/


BEGIN DROP_OBJ('USER', 'QLTH'); END;
/
--------------------------------------------------------------------------------
-- 2. TẠO USER QLTH VÀ CẤP CÁC QUYỀN CẦN THIẾT
--------------------------------------------------------------------------------
ALTER SESSION SET "_ORACLE_SCRIPT" = TRUE;
-- USER SQL
CREATE USER "QLTH" IDENTIFIED BY "QLTH"  CONTAINER = CURRENT;
ALTER SESSION SET "_ORACLE_SCRIPT" = FALSE;

-- QUOTAS
ALTER USER "QLTH" QUOTA UNLIMITED ON "USERS";

-- ROLES
GRANT "DBA" TO "QLTH" WITH ADMIN OPTION;
GRANT "CONNECT" TO "QLTH" WITH ADMIN OPTION;
GRANT "RESOURCE" TO "QLTH" WITH ADMIN OPTION;
GRANT SYSDBA TO QLTH;

-- SYSTEM PRIVILEGES
GRANT EXECUTE ANY PROCEDURE TO QLTH;
GRANT CREATE SESSION TO QLTH;
GRANT CREATE SESSION, CREATE VIEW, ALTER SESSION, CREATE SEQUENCE TO QLTH;
GRANT CREATE USER, CREATE ROLE, ALTER USER, ALTER ANY ROLE, DROP USER, DROP ANY ROLE TO QLTH;
GRANT CREATE SYNONYM, CREATE DATABASE LINK, RESOURCE , UNLIMITED TABLESPACE TO QLTH;
GRANT CREATE TRIGGER TO QLTH;
GRANT EXECUTE ON SYS.DBMS_SESSION TO QLTH;
GRANT EXECUTE ON DBMS_CRYPTO TO QLTH; 
GRANT EXEMPT ACCESS POLICY TO "QLTH";
--------------------------------------------------------------------------------
-- CẤP CÁC QUYỀN CẦN THIẾT ĐỂ CÀI ĐẶT OLS
GRANT UNLIMITED TABLESPACE TO QLTH; --CẤP QUOTA CHO QLTH 
GRANT SELECT ANY DICTIONARY TO QLTH; --CẤP QUYỀN ĐỌC DICTIONARY 
GRANT RESTRICTED SESSION TO QLTH;
---> CẤP QUYỀN EXECUTE CHO QLTH 
GRANT EXECUTE ON LBACSYS.SA_COMPONENTS TO QLTH WITH GRANT OPTION; 
GRANT EXECUTE ON LBACSYS.sa_user_admin TO QLTH WITH GRANT OPTION; 
GRANT EXECUTE ON LBACSYS.sa_label_admin TO QLTH WITH GRANT OPTION; 
GRANT EXECUTE ON sa_policy_admin TO QLTH WITH GRANT OPTION; 
GRANT EXECUTE ON char_to_label TO QLTH WITH GRANT OPTION; 
---> ADD QLTH VÀO LBAC_DBA
GRANT LBAC_DBA TO QLTH; 
GRANT EXECUTE ON sa_sysdba TO QLTH; 
GRANT EXECUTE ON TO_LBAC_DATA_LABEL TO QLTH;
--------------------------------------------------------------------------------
-- 3. TẠO CÁC ROLE
--------------------------------------------------------------------------------
ALTER SESSION SET "_ORACLE_SCRIPT" = TRUE;
CREATE ROLE RL_QLTH_SINHVIEN;
CREATE ROLE RL_QLTH_NHANVIEN;
CREATE ROLE RL_QLTH_GIANGVIEN;
CREATE ROLE RL_QLTH_GIAOVU;
CREATE ROLE RL_QLTH_TRUONGDV;
CREATE ROLE RL_QLTH_TRUONGKHOA;
ALTER SESSION SET "_ORACLE_SCRIPT" = FALSE;
--------------------------------------------------------------------------------
-- 4. TẠO CSDL TRÊN SCHEMA QLTH
--------------------------------------------------------------------------------
CREATE TABLE QLTH.QLTH_NHANSU(
    MANS NUMBER(6, 0),
    HOTEN NVARCHAR2(100),
    PHAI NVARCHAR2(4), -- Nam/Nữ/Khác
    NGSINH DATE,
    DIACHI NVARCHAR2(200),
    DT VARCHAR2(10),
    PHUCAP NUMBER,
    VAITRO NVARCHAR2(50), -- Nhân viên cơ bản/Giảng viên/Giáo vụ/Trưởng đơn vị/Trưởng khoa
    MADV VARCHAR2(10),
    MACS CHAR(3),
    
    CONSTRAINT PK_QLTH_NHANSU PRIMARY KEY(MANS)
);

--------------------------------------------------------------------------------
CREATE TABLE QLTH.QLTH_SINHVIEN(
    MASV NUMBER(8,0),
    HOTEN NVARCHAR2(100),
    PHAI NVARCHAR2(4), -- Nam/Nữ/Khác
    NGSINH DATE,
    DIACHI NVARCHAR2(200),
    DT VARCHAR2(10),
    MACT VARCHAR2(5),
    MANGANH VARCHAR2(10),
    SOTCTL NUMBER,
    DTBTL NUMBER,
    
    CONSTRAINT PK_QLTH_SINHVIEN PRIMARY KEY(MASV)
);

--------------------------------------------------------------------------------
-- BẢNG BỔ SUNG 
CREATE TABLE QLTH.QLTH_CHUONGTRINH(
    MACT VARCHAR2(5), -- CQ/CLC/CTTT/VP...
    TENCT NVARCHAR2(50), -- Chính quy, Chất lượng cao, ...
    SOHK NUMBER,
    
    CONSTRAINT PK_QLTH_CHUONGTRINH PRIMARY KEY(MACT)
);

CREATE TABLE QLTH.QLTH_NGANH(
    MANGANH VARCHAR2(10),
    TENNGANH NVARCHAR2(100),
    
    CONSTRAINT PK_QLTH_NGANH PRIMARY KEY(MANGANH)
);

CREATE TABLE QLTH.QLTH_THONGBAO (
    MATB NUMBER,
    NOIDUNG NVARCHAR2(1000),
    CONSTRAINT PK_QLTH_THONGBAO PRIMARY KEY(MATB)
);

CREATE TABLE QLTH.QLTH_COSO (
    MACS CHAR(3),
    TENCS NVARCHAR2(30),
    DIACHI NVARCHAR2(200), 
    
    CONSTRAINT PK_QLTH_COSO PRIMARY KEY(MACS)
);

CREATE TABLE QLTH.QLTH_THOIGIANDK (
    HK NUMBER,
    NAM CHAR(9),
    MACT VARCHAR2(5),
    NGAYBD TIMESTAMP, 
    NGAYKT TIMESTAMP,
    
    CONSTRAINT PK_QLTH_THOIGIANDK PRIMARY KEY(HK, NAM, MACT)
);

--------------------------------------------------------------------------------
CREATE TABLE QLTH.QLTH_DONVI(
    MADV VARCHAR2(10),
    TENDV NVARCHAR2(50),
    TRGDV NUMBER(6, 0),
    
    CONSTRAINT PK_QLTH_DONVI PRIMARY KEY(MADV)
);

--------------------------------------------------------------------------------
CREATE TABLE QLTH.QLTH_HOCPHAN(
    MAHP CHAR(8),
    TENHP NVARCHAR2(100),
    SOTC NUMBER,
    STLT NUMBER,
    STTH NUMBER,
    SOSVTD NUMBER,
    MADV VARCHAR2(10),
    
    CONSTRAINT PK_QLTH_HOCPHAN PRIMARY KEY(MAHP)
);

--------------------------------------------------------------------------------
CREATE TABLE QLTH.QLTH_KHMO(
    MAHP CHAR(8), -- CSC00003|MTH00148
    HK NUMBER, -- 1/2/3
    NAM CHAR(9), -- 2021-2022|2022-2023|2023-2024...
    MACT VARCHAR2(5),
    
    CONSTRAINT PK_QLTH_KHMO PRIMARY KEY(MAHP, HK, NAM, MACT)
);

--------------------------------------------------------------------------------
CREATE TABLE QLTH.QLTH_PHANCONG(
    MAGV NUMBER(6, 0),
    MAHP CHAR(8),
    HK NUMBER,
    NAM CHAR(9),
    MACT VARCHAR2(5),
    NGAYHOC CHAR(2), -- T2, T3, T4, T5, T6, T7,CN
    TIET VARCHAR2(7), -- 1-4, 1.5-2.5, 9.5-10
    
    CONSTRAINT PK_QLTH_PHANCONG PRIMARY KEY(MAHP, HK, NAM, MACT, NGAYHOC, TIET)
);

--------------------------------------------------------------------------------
CREATE TABLE QLTH.QLTH_DANGKY(
    MASV NUMBER(8,0),
    MAGV NUMBER(6, 0),
    MAHP CHAR(8),
    HK NUMBER,
    NAM CHAR(9),
    MACT VARCHAR2(5),
    NGAYHOC CHAR(2),
    TIET VARCHAR2(7),
    DIEMTHI NUMBER,
    DIEMQT NUMBER,
    DIEMCK NUMBER,
    DIEMTK NUMBER,
    
    CONSTRAINT PK_QLTH_DANGKY PRIMARY KEY(MASV, MAHP, HK, NAM, MACT)
);
--------------------------------------------------------------------------------
-- INSERT DATA
INSERT INTO "QLTH"."QLTH_CHUONGTRINH" (MACT, TENCT, SOHK) VALUES ('CQ', N'Chính quy - Chương trình chuẩn', 3);
INSERT INTO "QLTH"."QLTH_CHUONGTRINH" (MACT, TENCT, SOHK) VALUES ('CLC', N'Chất lượng cao', 3);
INSERT INTO "QLTH"."QLTH_CHUONGTRINH" (MACT, TENCT, SOHK) VALUES ('TT', N'Tiên tiến', 3);
INSERT INTO "QLTH"."QLTH_CHUONGTRINH" (MACT, TENCT, SOHK) VALUES ('VP', N'Việt-Pháp', 3);

INSERT INTO "QLTH"."QLTH_DANGKY" (MASV, MAGV, MAHP, HK, NAM, MACT, NGAYHOC, TIET) VALUES (21120270, 200000, 'CSC12001', 1, '2023-2024', 'CQ', 'T2', '1-4');
INSERT INTO "QLTH"."QLTH_DANGKY" (MASV, MAGV, MAHP, HK, NAM, MACT, NGAYHOC, TIET) VALUES (21120332, 200000, 'CSC12001', 1, '2023-2024', 'CQ', 'T2', '1-4');
INSERT INTO "QLTH"."QLTH_DANGKY" (MASV, MAGV, MAHP, HK, NAM, MACT, NGAYHOC, TIET) VALUES (21120347, 200000, 'CSC12001', 1, '2023-2024', 'CQ', 'T2', '1-4');
INSERT INTO "QLTH"."QLTH_DANGKY" (MASV, MAGV, MAHP, HK, NAM, MACT, NGAYHOC, TIET) VALUES (21120360, 200000, 'CSC12001', 1, '2023-2024', 'CQ', 'T2', '1-4');

INSERT INTO "QLTH"."QLTH_THOIGIANDK" (HK, NAM, MACT, NGAYBD, NGAYKT) VALUES(2, '2023-2024', 'CLC', TO_TIMESTAMP('2024-05-01 09:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-05-15 09:00:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO "QLTH"."QLTH_THOIGIANDK" (HK, NAM, MACT, NGAYBD, NGAYKT) VALUES(2, '2023-2024', 'CQ', TO_TIMESTAMP('2024-05-01 09:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-05-15 09:00:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO "QLTH"."QLTH_THOIGIANDK" (HK, NAM, MACT, NGAYBD, NGAYKT) VALUES(1, '2023-2024', 'CQ', TO_TIMESTAMP('2024-01-01 09:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-01-15 09:00:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO "QLTH"."QLTH_THOIGIANDK" (HK, NAM, MACT, NGAYBD, NGAYKT) VALUES (3, '2023-2024', 'CQ', TO_TIMESTAMP('2024-05-15 09:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP('2024-05-30 09:00:00', 'YYYY-MM-DD HH24:MI:SS'));

INSERT INTO "QLTH"."QLTH_COSO" (MACS, TENCS, DIACHI) VALUES ('CS1', N'Cơ sở 1', N'227 Nguyễn Văn Cừ, Phường 4, Quận 5, Thành phố Hồ Chí Minh');
INSERT INTO "QLTH"."QLTH_COSO" (MACS, TENCS, DIACHI) VALUES ('CS2', N'Cơ sở 2', N'Khu phố 6, phường Linh Trung, quận Thủ Đức, TP.HCM');

INSERT INTO "QLTH"."QLTH_DONVI" (MADV,TENDV,TRGDV) VALUES ('VPK',N'Văn phòng khoa',500000);
INSERT INTO "QLTH"."QLTH_DONVI" (MADV,TENDV,TRGDV) VALUES ('HTTT',N'Bộ môn HTTT', 400001);
INSERT INTO "QLTH"."QLTH_DONVI" (MADV,TENDV,TRGDV) VALUES ('CNPM',N'Bộ môn CNPM',400002);      
INSERT INTO "QLTH"."QLTH_DONVI" (MADV,TENDV,TRGDV) VALUES ('KHMT',N'Bộ môn KHMT',400003);      
INSERT INTO "QLTH"."QLTH_DONVI" (MADV,TENDV,TRGDV) VALUES ('CNTT',N'Bộ môn CNTT',400004);      
INSERT INTO "QLTH"."QLTH_DONVI" (MADV,TENDV,TRGDV) VALUES ('TGMT',N'Bộ môn TGMT',400005);      
INSERT INTO "QLTH"."QLTH_DONVI" (MADV,TENDV,TRGDV) VALUES ('MMT',N'Bộ môn MMT-VT',400006);      

INSERT INTO "QLTH"."QLTH_HOCPHAN" (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('CSC12001', N'An toàn và bảo mật dữ liệu trong hệ thống thông tin', 4, 45, 15, 'HTTT');
INSERT INTO "QLTH"."QLTH_HOCPHAN" (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('CSC12103', N'Chuyên đề Hệ quản trị cơ sở dữ liệu nâng cao', 4, 45, 15, 'HTTT');
INSERT INTO "QLTH"."QLTH_HOCPHAN" (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('CSC14003', N'Cơ sở trí tuệ nhân tạo', 4, 45, 15, 'CNPM');
INSERT INTO "QLTH"."QLTH_HOCPHAN" (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('CSC12004', N'Phân tích thiết kế hệ thống thông tin', 4, 45, 15, 'HTTT');
INSERT INTO "QLTH"."QLTH_HOCPHAN" (MAHP, TENHP, SOTC, STLT, STTH, MADV) VALUES ('CSC10001', N'Nhập môn lập trình', '4', '45', '15', 'VPK');

INSERT INTO "QLTH"."QLTH_KHMO" (MAHP, HK, NAM, MACT) VALUES ('CSC12001', 1, '2023-2024', 'CQ');
INSERT INTO "QLTH"."QLTH_KHMO" (MAHP, HK, NAM, MACT) VALUES ('CSC12103', 2, '2023-2024', 'CQ');
INSERT INTO "QLTH"."QLTH_KHMO" (MAHP, HK, NAM, MACT) VALUES ('CSC14003', 1, '2023-2024', 'CQ');
INSERT INTO "QLTH"."QLTH_KHMO" (MAHP, HK, NAM, MACT) VALUES ('CSC12004', 2, '2023-2024', 'CLC');
INSERT INTO "QLTH"."QLTH_KHMO" (MAHP, HK, NAM, MACT) VALUES ('CSC12001', 3, '2023-2024', 'CQ');
INSERT INTO "QLTH"."QLTH_KHMO" (MAHP, HK, NAM, MACT) VALUES ('CSC10001', '3', '2023-2024', 'CQ');

INSERT INTO "QLTH"."QLTH_NGANH" (MANGANH, TENNGANH) VALUES ('7480201_NN', N'Nhóm ngành máy tính và Công nghệ thông tin');
INSERT INTO "QLTH"."QLTH_NGANH" (MANGANH, TENNGANH) VALUES ('7480107', N'Trí tuệ nhân tạo');
INSERT INTO "QLTH"."QLTH_NGANH" (MANGANH, TENNGANH) VALUES ('7480101_TT', N'Khoa học máy tính');

INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (100000, N'Nguyễn Văn A', N'Nam', N'Nhân viên cơ bản', 'VPK', 'CS1');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (100001, N'Nguyễn Thị B', N'Nữ', N'Nhân viên cơ bản', 'HTTT', 'CS1');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (100002, N'Nguyễn Văn C', N'Nam', N'Nhân viên cơ bản', 'CNPM', 'CS1');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (100003, N'Nguyễn Thị D', N'Nữ', N'Nhân viên cơ bản', 'KHMT', 'CS1');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (100004, N'Nguyễn Văn E', N'Nam', N'Nhân viên cơ bản', 'CNTT', 'CS1');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (100005, N'Nguyễn Thị G', N'Nữ', N'Nhân viên cơ bản', 'TGMT', 'CS1');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (100006, N'Nguyễn Văn H', N'Nam', N'Nhân viên cơ bản', 'MMT', 'CS1');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (100007, N'Nguyễn Thị Y', N'Nữ', N'Nhân viên cơ bản', 'VPK', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (100008, N'Nguyễn Văn K', N'Nam', N'Nhân viên cơ bản', 'VPK', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (100009, N'Nguyễn Thị L', N'Nữ', N'Nhân viên cơ bản', 'VPK', 'CS2');

INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200000, N'Nguyễn Thị A', N'Nữ', N'Giảng viên', 'HTTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200001, N'Nguyễn Hoàng B', N'Nam', N'Giảng viên', 'HTTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200002, N'Nguyễn Thị C', N'Nữ', N'Giảng viên', 'HTTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200003, N'Nguyễn Hoàng D', N'Nam', N'Giảng viên', 'HTTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200004, N'Nguyễn Thị E', N'Nữ', N'Giảng viên', 'HTTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200005, N'Nguyễn Hoàng G', N'Nam', N'Giảng viên', 'HTTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200006, N'Nguyễn Thị H', N'Nữ', N'Giảng viên', 'HTTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200007, N'Nguyễn Hoàng Y', N'Nam', N'Giảng viên', 'CNPM');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200008, N'Nguyễn Thị K', N'Nữ', N'Giảng viên', 'CNPM');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200009, N'Nguyễn Hoàng L', N'Nam', N'Giảng viên', 'CNPM');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200010, N'Nguyễn Thị M', N'Nữ', N'Giảng viên', 'CNPM');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200011, N'Nguyễn Hoàng N', N'Nam', N'Giảng viên', 'CNPM');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200012, N'Nguyễn Thị O', N'Nữ', N'Giảng viên', 'CNPM');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200013, N'Nguyễn Hoàng P', N'Nam', N'Giảng viên', 'CNPM');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200014, N'Nguyễn Thị Q', N'Nữ', N'Giảng viên', 'KHMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200015, N'Nguyễn Hoàng R', N'Nam', N'Giảng viên', 'KHMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200016, N'Nguyễn Thị S', N'Nữ', N'Giảng viên', 'KHMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200017, N'Nguyễn Hoàng T', N'Nam', N'Giảng viên', 'KHMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200018, N'Nguyễn Thị U', N'Nữ', N'Giảng viên', 'KHMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200019, N'Nguyễn Hoàng V', N'Nam', N'Giảng viên', 'KHMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200020, N'Nguyễn Thị X', N'Nữ', N'Giảng viên', 'KHMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200021, N'Nguyễn Hoàng AA', N'Nam', N'Giảng viên', 'CNTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200022, N'Nguyễn Thị BB', N'Nữ', N'Giảng viên', 'CNTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200023, N'Nguyễn Hoàng CC', N'Nam', N'Giảng viên', 'CNTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200024, N'Nguyễn Thị DD', N'Nữ', N'Giảng viên', 'CNTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200025, N'Nguyễn Hoàng EE', N'Nam', N'Giảng viên', 'CNTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200026, N'Nguyễn Thị GG', N'Nữ', N'Giảng viên', 'CNTT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200027, N'Nguyễn Hoàng HH', N'Nam', N'Giảng viên', 'TGMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200028, N'Nguyễn Thị YY', N'Nữ', N'Giảng viên', 'TGMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200029, N'Nguyễn Hoàng KK', N'Nam', N'Giảng viên', 'TGMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200030, N'Nguyễn Thị LL', N'Nữ', N'Giảng viên', 'TGMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200031, N'Nguyễn Hoàng MM', N'Nam', N'Giảng viên', 'TGMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200032, N'Nguyễn Thị NN', N'Nữ', N'Giảng viên', 'TGMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200033, N'Nguyễn Hoàng OO', N'Nam', N'Giảng viên', 'MMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200034, N'Nguyễn Thị PP', N'Nữ', N'Giảng viên', 'MMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200035, N'Nguyễn Hoàng QQ', N'Nam', N'Giảng viên', 'MMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200036, N'Nguyễn Thị RR', N'Nữ', N'Giảng viên', 'MMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200037, N'Nguyễn Hoàng SS', N'Nam', N'Giảng viên', 'MMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200038, N'Nguyễn Thị TT', N'Nữ', N'Giảng viên', 'MMT');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV) VALUES (200039, N'Nguyễn Hoàng UU', N'Nam', N'Giảng viên', 'MMT');

INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (300000, N'Trần Văn A', N'Nam', N'Giáo vụ', 'HTTT', 'CS1');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (300001, N'Trần Văn B', N'Nam', N'Giáo vụ', 'HTTT', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (300002, N'Trần Văn C', N'Nam', N'Giáo vụ', 'KHMT', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (300003, N'Trần Văn D', N'Nam', N'Giáo vụ', 'CNPM', 'CS1');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (300004, N'Trần Văn E', N'Nam', N'Giáo vụ', 'TGMT', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (300005, N'Trần Văn G', N'Nam', N'Giáo vụ', 'CNTT', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (300006, N'Trần Văn H', N'Nam', N'Giáo vụ', 'VPK', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (300007, N'Trần Văn Y', N'Nam', N'Giáo vụ', 'CNTT', 'CS1');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (300008, N'Trần Văn K', N'Nam', N'Giáo vụ', 'MMT', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (300009, N'Trần Văn L', N'Nam', N'Giáo vụ', 'VPK', 'CS1');

INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (400001, N'Trương Nguyệt B', N'Nữ', N'Trưởng đơn vị', 'HTTT', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (400002, N'Trương Nguyệt C', N'Nữ', N'Trưởng đơn vị', 'CNPM', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (400003, N'Trương Nguyệt D', N'Nữ', N'Trưởng đơn vị', 'KHMT', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (400004, N'Trương Nguyệt E', N'Nữ', N'Trưởng đơn vị', 'CNTT', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (400005, N'Trương Nguyệt G', N'Nữ', N'Trưởng đơn vị', 'TGMT', 'CS2');
INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (400006, N'Trương Nguyệt H', N'Nữ', N'Trưởng đơn vị', 'MMT', 'CS2');

INSERT INTO "QLTH"."QLTH_NHANSU" (MANS, HOTEN, PHAI, VAITRO, MADV, MACS) VALUES (500000, N'Đinh Bá Tiến', N'Nam', N'Trưởng khoa', 'VPK', 'CS1');

INSERT INTO "QLTH"."QLTH_PHANCONG" (MAGV, MAHP, HK, NAM, MACT, NGAYHOC, TIET) VALUES (200000, 'CSC12001', 1, '2023-2024', 'CQ', 'T2', '1-4');
INSERT INTO "QLTH"."QLTH_PHANCONG" (MAGV, MAHP, HK, NAM, MACT, NGAYHOC, TIET) VALUES (200002, 'CSC12001', 1, '2023-2024', 'CQ', 'T2', '6-9');
INSERT INTO "QLTH"."QLTH_PHANCONG" (MAGV, MAHP, HK, NAM, MACT, NGAYHOC, TIET) VALUES (200001, 'CSC12001', 3, '2023-2024', 'CQ', 'T5', '1-4');
INSERT INTO "QLTH"."QLTH_PHANCONG" (MAGV, MAHP, HK, NAM, MACT, NGAYHOC, TIET) VALUES (200003, 'CSC12001', 3, '2023-2024', 'CQ', 'T5', '6-9');
INSERT INTO "QLTH"."QLTH_PHANCONG" (MAGV, MAHP, HK, NAM, MACT, NGAYHOC, TIET) VALUES (200012, 'CSC10001', 3, '2023-2024', 'CQ', 'T7', '1-4');


INSERT INTO "QLTH"."QLTH_SINHVIEN" (MASV, HOTEN, PHAI, MACT) VALUES (21120270, N'Huỳnh Lê Đăng Khoa', N'Nam', 'CQ');
INSERT INTO "QLTH"."QLTH_SINHVIEN" (MASV, HOTEN, PHAI, MACT) VALUES (21120332, N'Đào Cẩm Thanh', N'Nữ','CQ');
INSERT INTO "QLTH"."QLTH_SINHVIEN" (MASV, HOTEN, PHAI, MACT) VALUES (21120347, N'Nguyễn Khắc Triệu', N'Nam','CQ');
INSERT INTO "QLTH"."QLTH_SINHVIEN" (MASV, HOTEN, PHAI, MACT) VALUES (21120360, N'Trần Ý Văn', N'Nam','CQ');

INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1001,N'Đây là thông báo dành cho trưởng khoa, chỉ có trưởng khoa mới xem được.'); -- DataLabel: TK
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1002,N'Đây là thông báo dành cho trưởng bộ môn.'); -- DataLabel: TDHTTT
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1003,N'Đây là thông báo dành cho các trưởng bộ môn cơ sở 1.'); -- DataLabel: TDV:CS1
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1004,N'Đây là thông báo dành cho giáo vụ của bộ môn hệ thống thông tin.'); -- DataLabel: GVU:HTTT
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1005,N'Đây là thông báo dành cho tất cả giáo vụ.'); -- DataLabel: GVU
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1006,N'Đây là thông báo dành cho tất cả các trưởng bộ môn ngành HTTT.'); -- DataLabel: TDV:HTTT
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1007,N'Đây là thông báo dành cho sinh viên ngành hệ thống thông tin học ở cơ sở 1.'); -- DataLabel: SV:HTTT:CS1
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1008,N'Đây là thông báo dành cho trưởng bộ môn ngành KHMT ở cơ sở 1.'); -- DataLabel: TDV:KHMT:CS1
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1009,N'Đây là thông báo dành cho tất cả các sinh viên trong khoa.'); -- DataLabel: SV
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1010,N'Đây là thông báo dành cho trưởng bộ môn ngành KHMT ở cơ sở 1 và cơ sở 2.'); -- DataLabel: TDV:KHMT
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1011,N'Đây là thông báo dành cho tất cả các giảng viên bộ môn hệ thống thông tin.'); -- DataLabel: GVIEN:HTTT
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1012,N'Đây là thông báo dành cho các nhân viên ở cơ sở 2.'); -- DataLabel: NV::CS2
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1013,N'Đây là thông báo dành cho tất cả các giảng viên trong khoa.'); -- DataLabel: GVIEN
INSERT INTO "QLTH"."QLTH_THONGBAO" (MATB,NOIDUNG) VALUES(1014,N'Đây là thông báo dành cho các giáo viên CNPM ở cơ sở 1.'); -- DataLabel: GVIEN:CNPM:CS1

--------------------------------------------------------------------------------
-- CREATE FOREIGN KEYS
ALTER TABLE QLTH.QLTH_NHANSU
ADD CONSTRAINT FK_NHANSU_DONVI FOREIGN KEY(MADV) REFERENCES QLTH.QLTH_DONVI;
ALTER TABLE QLTH.QLTH_NHANSU
ADD CONSTRAINT FK_NHANSU_COSO FOREIGN KEY(MACS) REFERENCES QLTH.QLTH_COSO;

ALTER TABLE QLTH.QLTH_SINHVIEN
ADD CONSTRAINT FK_SINHVIEN_NGANH FOREIGN KEY(MANGANH) REFERENCES QLTH.QLTH_NGANH;
ALTER TABLE QLTH.QLTH_SINHVIEN
ADD CONSTRAINT FK_SINHVIEN_CHUONGTRINH FOREIGN KEY(MACT) REFERENCES QLTH.QLTH_CHUONGTRINH;

ALTER TABLE QLTH.QLTH_DONVI
ADD CONSTRAINT FK_DONVI_NHANSU FOREIGN KEY(TRGDV) REFERENCES QLTH.QLTH_NHANSU;

ALTER TABLE QLTH.QLTH_HOCPHAN
ADD CONSTRAINT FK_HOCPHAN_DONVI FOREIGN KEY(MADV) REFERENCES QLTH.QLTH_DONVI;

ALTER TABLE QLTH.QLTH_KHMO
ADD CONSTRAINT FK_KHMO_HOCPHAN FOREIGN KEY(MAHP) REFERENCES QLTH.QLTH_HOCPHAN;
/*
ALTER TABLE QLTH.QLTH_KHMO
ADD CONSTRAINT FK_KHMO_THOIGIANDK FOREIGN KEY(HK, NAM, MACT) REFERENCES QLTH.QLTH_THOIGIANDK ON DELETE CASCADE;
*/

ALTER TABLE QLTH.QLTH_PHANCONG
ADD CONSTRAINT FK_PHANCONG_NHANSU FOREIGN KEY(MAGV) REFERENCES QLTH.QLTH_NHANSU;
ALTER TABLE QLTH.QLTH_PHANCONG
ADD CONSTRAINT FK_PHANCONG_KHMO FOREIGN KEY(MAHP, HK, NAM, MACT) REFERENCES QLTH.QLTH_KHMO;

ALTER TABLE QLTH.QLTH_THOIGIANDK
ADD CONSTRAINT FK_TGDK_CHUONGTRINH FOREIGN KEY(MACT) REFERENCES QLTH.QLTH_CHUONGTRINH;

ALTER TABLE QLTH.QLTH_DANGKY
ADD CONSTRAINT FK_DANGKY_SINHVIEN FOREIGN KEY(MASV) REFERENCES QLTH.QLTH_SINHVIEN;
ALTER TABLE QLTH.QLTH_DANGKY
ADD CONSTRAINT FK_DANGKY_PHANCONG FOREIGN KEY(MAHP, HK, NAM, MACT, NGAYHOC, TIET) REFERENCES QLTH.QLTH_PHANCONG(MAHP, HK, NAM, MACT, NGAYHOC, TIET);

--------------------------------------------------------------------------------
-- 5. TẠO CÁC USER CỦA DB QLTH VÀ CẤP CÁC ROLE TƯƠNG ỨNG CHO CÁC USER ĐÓ 
--------------------------------------------------------------------------------
-- DROP USER
--alter session set "_oracle_script"=true;
CREATE OR REPLACE PROCEDURE USP_DROPUSER_QLTH_NHANSU
AS
    CURSOR CUR IS (SELECT TO_CHAR(MANS)
                    FROM QLTH.QLTH_NHANSU
                    WHERE TO_CHAR(MANS) IN (SELECT USERNAME FROM ALL_USERS)
                    );
    STRSQL VARCHAR(2000);
    N2 VARCHAR2(6);
BEGIN
    OPEN CUR;
    LOOP
        FETCH CUR INTO N2;
        EXIT WHEN CUR%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE(N2);
            
        STRSQL := 'DROP USER "'||N2||'" CASCADE';
        EXECUTE IMMEDIATE(STRSQL);
    END LOOP;
    CLOSE CUR;
END;
/

CREATE OR REPLACE PROCEDURE USP_DROPUSER_QLTH_SINHVIEN
AS
    CURSOR CUR IS (SELECT TO_CHAR(MASV)
                    FROM QLTH.QLTH_SINHVIEN
                    WHERE TO_CHAR(MASV) IN (SELECT USERNAME FROM ALL_USERS)
                    );
    STRSQL VARCHAR(2000);
    N2 VARCHAR2(8);
BEGIN
    OPEN CUR;
    LOOP
        FETCH CUR INTO N2;
        EXIT WHEN CUR%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE(N2);
            
        STRSQL := 'DROP USER "'||N2||'" CASCADE';
        EXECUTE IMMEDIATE(STRSQL);
    END LOOP;
    CLOSE CUR;
END;
/

BEGIN 
    USP_DROPUSER_QLTH_SINHVIEN;
END;
/

BEGIN 
    USP_DROPUSER_QLTH_NHANSU;
END;
/

ALTER SESSION SET CONTAINER = XEPDB1;
-- CREATE USER
CREATE OR REPLACE PROCEDURE USP_CREATEUSER_QLTH_NHANSU
AS
    CURSOR CUR IS (SELECT TO_CHAR(MANS)
                    FROM QLTH.QLTH_NHANSU
                    WHERE TO_CHAR(MANS) NOT IN (SELECT USERNAME FROM ALL_USERS)
                    );
    STRSQL VARCHAR(2000);
    N2 VARCHAR2(6);
BEGIN
    OPEN CUR;
    LOOP
        FETCH CUR INTO N2;
        EXIT WHEN CUR%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE(N2);
            
        STRSQL := 'CREATE USER "'||N2||'" IDENTIFIED BY "' || 123456 || '" CONTAINER = CURRENT';
        EXECUTE IMMEDIATE(STRSQL);
        STRSQL := 'GRANT CONNECT, RESOURCE, RESTRICTED SESSION TO "'|| N2 || '"';
        EXECUTE IMMEDIATE(STRSQL);
    END LOOP;
    CLOSE CUR;
END;
/

BEGIN 
    USP_CREATEUSER_QLTH_NHANSU;
END;
/

CREATE OR REPLACE PROCEDURE USP_CREATEUSER_QLTH_SINHVIEN
AS
    CURSOR CUR IS (SELECT TO_CHAR(MASV)
                    FROM QLTH.QLTH_SINHVIEN
                    WHERE TO_CHAR(MASV) NOT IN (SELECT USERNAME FROM ALL_USERS)
                    );
    STRSQL VARCHAR(2000);
    N2 VARCHAR2(8);
BEGIN
    OPEN CUR;
    LOOP
        FETCH CUR INTO N2;
        EXIT WHEN CUR%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE(N2);
            
        STRSQL := 'CREATE USER "'||N2||'" IDENTIFIED BY "' || 123456 || '" CONTAINER = CURRENT';
        EXECUTE IMMEDIATE(STRSQL);
        STRSQL := 'GRANT CONNECT, RESOURCE, RESTRICTED SESSION TO "'|| N2 || '"';
        EXECUTE IMMEDIATE(STRSQL);
    END LOOP;
    CLOSE CUR;
END;
/

BEGIN 
    USP_CREATEUSER_QLTH_SINHVIEN;
END;
/

CREATE OR REPLACE PROCEDURE USP_GRANTROLE_QLTH_SINHVIEN
    (STRROLE VARCHAR)
AS
    CURSOR CUR IS (SELECT TO_CHAR(MASV)
                    FROM QLTH.QLTH_SINHVIEN
                    WHERE TO_CHAR(MASV) IN (SELECT USERNAME
                                        FROM ALL_USERS));
    STRSQL VARCHAR(2000);
    N2 VARCHAR2(8);
BEGIN
    OPEN CUR;
    LOOP
        FETCH CUR INTO N2;
        EXIT WHEN CUR%NOTFOUND;
        
        STRSQL := 'GRANT "'||STRROLE||'" TO "'||N2||'"';
        EXECUTE IMMEDIATE (STRSQL);
    END LOOP;
    CLOSE CUR;
END;
/

BEGIN USP_GRANTROLE_QLTH_SINHVIEN('RL_QLTH_SINHVIEN'); END;
/

CREATE OR REPLACE PROCEDURE USP_GRANTROLE_QLTH_NHANSU
    (STRROLE VARCHAR, LOAI NVARCHAR2)
AS
    CURSOR CUR IS (SELECT TO_CHAR(MANS)
                    FROM QLTH.QLTH_NHANSU
                    WHERE TO_CHAR(MANS) IN (SELECT USERNAME
                                        FROM ALL_USERS)
                    AND VAITRO = LOAI);
    STRSQL VARCHAR(2000);
    N2 VARCHAR2(6);
BEGIN
    OPEN CUR;
    LOOP
        FETCH CUR INTO N2;
        EXIT WHEN CUR%NOTFOUND;
        
        STRSQL := 'GRANT "'||STRROLE||'" TO "'||N2||'"';
        EXECUTE IMMEDIATE (STRSQL);
    END LOOP;
    CLOSE CUR;
END;
/
-- select * from dba_role_privs where granted_role = 'RL_QLTH_NHANVIEN';
BEGIN USP_GRANTROLE_QLTH_NHANSU('RL_QLTH_NHANVIEN', N'Nhân viên cơ bản'); END;
/
BEGIN USP_GRANTROLE_QLTH_NHANSU('RL_QLTH_GIANGVIEN', N'Giảng viên'); END;
/
BEGIN USP_GRANTROLE_QLTH_NHANSU('RL_QLTH_GIAOVU', N'Giáo vụ'); END;
/
BEGIN USP_GRANTROLE_QLTH_NHANSU('RL_QLTH_TRUONGDV', N'Trưởng đơn vị'); END;
/
BEGIN USP_GRANTROLE_QLTH_NHANSU('RL_QLTH_TRUONGKHOA', N'Trưởng khoa'); END;
/
